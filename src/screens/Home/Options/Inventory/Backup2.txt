import React, { useState, useEffect } from 'react';
import { RoundedScrollContainer, SafeAreaView } from '@components/containers';
import { NavigationHeader } from '@components/Header';
import { TextInput as FormInput } from '@components/common/TextInput';
import { DropdownSheet } from '@components/common/BottomSheets';
import {
  fetchInvoiceDropdown,
  fetchPurchaseReturnDropdown,
  fetchSalesReturnDropdown,
  fetchServiceDropdown,
  fetchServiceReturnDropdown,
  fetchStockTransferDropdown,
  fetchVendorBillDropdown
} from '@api/dropdowns/dropdownApi';
import { reasons } from '@constants/dropdownConst';
const InventoryForm = ({ navigation }) => {
  const [isVisible, setIsVisible] = useState(false);
  const [selectedType, setSelectedType] = useState(null);
  console.log("ðŸš€ ~ InventoryForm ~ selectedType:", selectedType)
  const [formData, setFormData] = useState({
    reason: '',
    sales: '',
    service: '',
    purchase: '',
    serviceReturn: '',
    purchaseReturn: '',
    salesReturn: '',
    stockTransfer: '',
    remarks: '',
  });

  console.log("ðŸš€ ~ InventoryForm ~ formData:", formData)
  const [dropdown, setDropdown] = useState({
    invoice: [],
    service: [],
    serviceReturn: [],
    purchaseReturn: [],
    salesReturn: [],
    stockTransfer: [],
    vendorBill: [],
  });

  useEffect(() => {
    const fetchData = () => {
      fetchInvoiceDropdown()
        .then(res => {
          setDropdown(prevState => ({
            ...prevState,
            invoice: res.map(data => ({ id: data._id, label: data.sequence_no }))
          }));
        })
        .catch(error => console.error('Error fetching invoice dropdown:', error));

      fetchPurchaseReturnDropdown()
        .then(res => {
          setDropdown(prevState => ({
            ...prevState,
            purchaseReturn: res.map(data => ({ id: data._id, label: data.sequence_no }))
          }));
        })
        .catch(error => console.error('Error fetching purchase return dropdown:', error));

      fetchSalesReturnDropdown()
        .then(res => {
          setDropdown(prevState => ({
            ...prevState,
            salesReturn: res.map(data => ({ id: data._id, label: data.sequence_no }))
          }));
        })
        .catch(error => console.error('Error fetching sales return dropdown:', error));

      fetchServiceDropdown()
        .then(res => {
          setDropdown(prevState => ({
            ...prevState,
            service: res.map(data => ({ id: data._id, label: data.sequence_no }))
          }));
        })
        .catch(error => console.error('Error fetching service dropdown:', error));

      fetchServiceReturnDropdown()
        .then(res => {
          setDropdown(prevState => ({
            ...prevState,
            serviceReturn: res.map(data => ({ id: data._id, label: data.sequence_no }))
          }));
        })
        .catch(error => console.error('Error fetching service return dropdown:', error));

      fetchStockTransferDropdown()
        .then(res => {
          setDropdown(prevState => ({
            ...prevState,
            stockTransfer: res.map(data => ({ id: data._id, label: data.sequence_no }))
          }));
        })
        .catch(error => console.error('Error fetching stock transfer dropdown:', error));

      fetchVendorBillDropdown()
        .then(res => {
          setDropdown(prevState => ({
            ...prevState,
            vendorBill: res.map(data => ({ id: data._id, label: data.sequence_no }))
          }));
        })
        .catch(error => console.error('Error fetching vendor bill dropdown:', error));
    };

    fetchData();
  }, []);

  const handleFieldChange = (field, value) => {
    setFormData(prevState => ({
      ...prevState,
      [field]: value,
    }));
  };

  const toggleBottomSheet = (type) => {
    setSelectedType(type);
    setIsVisible(true);
  };

  const renderBottomSheet = () => {
    let items = [];
    let fieldName = '';

    switch (selectedType) {
      case 'Select Reason':
        items = reasons;
        fieldName = 'reason';
        break;
      case 'Sales':
        items = dropdown.invoice;
        fieldName = 'sales';
        break;
      case 'Service':
        items = dropdown.service;
        fieldName = 'service';
        break;
      case 'Service Return':
        items = dropdown.serviceReturn;
        fieldName = 'serviceReturn';
        break;
      case 'Sales Return':
        items = dropdown.salesReturn;
        fieldName = 'salesReturn';
        break;
      case 'Purchase Return':
        items = dropdown.purchaseReturn;
        fieldName = 'purchaseReturn';
        break;
      case 'Stock Transfer':
        items = dropdown.stockTransfer;
        fieldName = 'stockTransfer';
        break;
      case 'Vendor Bill':
        items = dropdown.vendorBill;
        fieldName = 'vendorBill';
        break;
      default:
        return null;
    }

    return (
      <DropdownSheet
        isVisible={isVisible}
        items={items}
        title={selectedType}
        onValueChange={(value) => handleFieldChange('reason', value.label)} 
      />
    );
  };

  const renderDynamicField = () => {
    switch (formData.reason?.label?.toLowerCase()) {
      case 'sales':
        return (
          <FormInput
            label={'Select Sales'}
            placeholder={'Select Sales'}
            dropIcon={'menu-down'}
            editable={false}
            value={formData.sales}
            multiline={true}
            onPress={() => toggleBottomSheet('Sales')}
          />
        );
      case 'service':
        return (
          <FormInput
            label={'Select Service'}
            placeholder={'Select Service'}
            dropIcon={'menu-down'}
            editable={false}
            value={formData.service}
            multiline={true}
            onPress={() => toggleBottomSheet('Service')}
          />
        );
      case 'purchase':
        return (
          <FormInput
            label={'Select Purchase'}
            placeholder={'Select Purchase'}
            dropIcon={'menu-down'}
            editable={false}
            value={formData.purchase}
            multiline={true}
            onPress={() => toggleBottomSheet('Purchase')}
          />
        );
      case 'purchase return':
        return (
          <FormInput
            label={'Select Purchase Return'}
            placeholder={'Select Purchase Return'}
            dropIcon={'menu-down'}
            editable={false}
            value={formData.purchaseReturn}
            multiline={true}
            onPress={() => toggleBottomSheet('Purchase Return')}
          />
        );
      case 'sales return':
        return (
          <FormInput
            label={'Select Sales Return'}
            placeholder={'Select Sales Return'}
            dropIcon={'menu-down'}
            editable={false}
            value={formData.salesReturn}
            multiline={true}
            onPress={() => toggleBottomSheet('Sales Return')}
          />
        );
      case 'service return':
        return (
          <FormInput
            label={'Select Service Return'}
            placeholder={'Select Service Return'}
            dropIcon={'menu-down'}
            editable={false}
            value={formData.serviceReturn}
            multiline={true}
            onPress={() => toggleBottomSheet('Service Return')}
          />
        );
      case 'stock transfer':
        return (
          <FormInput
            label={'Select Stock Transfer'}
            placeholder={'Select Stock Transfer'}
            dropIcon={'menu-down'}
            editable={false}
            value={formData.stockTransfer}
            multiline={true}
            onPress={() => toggleBottomSheet('Stock Transfer')}
          />
        );
      default:
        break;
    }
  };

  return (
    <SafeAreaView>
      <NavigationHeader
        title={'Box Opening Request'}
        onBackPress={() => navigation.goBack()}
      />
      <RoundedScrollContainer>
        <FormInput
          label={'Select Reasons'}
          placeholder={'Select Reason'}
          dropIcon={'menu-down'}
          editable={false}
          value={formData.reason}
          multiline={true}
          onPress={() => toggleBottomSheet('Select Reason')}
        />
        {/* {renderDynamicField()} */}
        <FormInput
          label={'Remarks'}
          multiline={true}
          numberOfLines={5}
          placeholder={'Enter remarks'}
          onChangeText={(text) => handleFieldChange('remarks', text)}
        />
        {renderBottomSheet()}
      </RoundedScrollContainer>
    </SafeAreaView>
  );
};

export default InventoryForm;
